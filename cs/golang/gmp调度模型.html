<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>GMP调度模型 | Notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.4b6acbbd.css" as="style"><link rel="preload" href="/assets/js/app.7fb0f4ce.js" as="script"><link rel="preload" href="/assets/js/2.c7317423.js" as="script"><link rel="preload" href="/assets/js/24.afc783ad.js" as="script"><link rel="prefetch" href="/assets/js/10.df1b1af3.js"><link rel="prefetch" href="/assets/js/11.1279d4dd.js"><link rel="prefetch" href="/assets/js/12.121cf2f1.js"><link rel="prefetch" href="/assets/js/13.79210df7.js"><link rel="prefetch" href="/assets/js/14.a47039d6.js"><link rel="prefetch" href="/assets/js/15.d0e05853.js"><link rel="prefetch" href="/assets/js/16.0e89df48.js"><link rel="prefetch" href="/assets/js/17.d6cdd9d3.js"><link rel="prefetch" href="/assets/js/18.a8fed842.js"><link rel="prefetch" href="/assets/js/19.c6052195.js"><link rel="prefetch" href="/assets/js/20.2a584816.js"><link rel="prefetch" href="/assets/js/21.4b9954e1.js"><link rel="prefetch" href="/assets/js/22.e1340920.js"><link rel="prefetch" href="/assets/js/23.a24588c5.js"><link rel="prefetch" href="/assets/js/25.373526bb.js"><link rel="prefetch" href="/assets/js/26.5c42c25f.js"><link rel="prefetch" href="/assets/js/27.85b64eba.js"><link rel="prefetch" href="/assets/js/28.1a55cf28.js"><link rel="prefetch" href="/assets/js/29.32608d91.js"><link rel="prefetch" href="/assets/js/3.705706f2.js"><link rel="prefetch" href="/assets/js/30.2f08f732.js"><link rel="prefetch" href="/assets/js/31.02da5ad1.js"><link rel="prefetch" href="/assets/js/32.0aa0124a.js"><link rel="prefetch" href="/assets/js/33.8d2474b3.js"><link rel="prefetch" href="/assets/js/34.25937387.js"><link rel="prefetch" href="/assets/js/35.23bdc8d1.js"><link rel="prefetch" href="/assets/js/36.be6dc842.js"><link rel="prefetch" href="/assets/js/37.18dcf644.js"><link rel="prefetch" href="/assets/js/38.bf256366.js"><link rel="prefetch" href="/assets/js/39.8182e3c8.js"><link rel="prefetch" href="/assets/js/4.76ed34bd.js"><link rel="prefetch" href="/assets/js/40.ee89d836.js"><link rel="prefetch" href="/assets/js/41.50f2b168.js"><link rel="prefetch" href="/assets/js/42.d8212083.js"><link rel="prefetch" href="/assets/js/43.41e5910d.js"><link rel="prefetch" href="/assets/js/44.cbdfc0f8.js"><link rel="prefetch" href="/assets/js/45.99296b2b.js"><link rel="prefetch" href="/assets/js/46.ac56bfc7.js"><link rel="prefetch" href="/assets/js/47.0f30f148.js"><link rel="prefetch" href="/assets/js/48.73d76ad6.js"><link rel="prefetch" href="/assets/js/49.a34467b0.js"><link rel="prefetch" href="/assets/js/5.ff1a6210.js"><link rel="prefetch" href="/assets/js/50.1236f0bd.js"><link rel="prefetch" href="/assets/js/51.bb9d3d6e.js"><link rel="prefetch" href="/assets/js/52.fb26b339.js"><link rel="prefetch" href="/assets/js/53.263e7243.js"><link rel="prefetch" href="/assets/js/54.acdf65c5.js"><link rel="prefetch" href="/assets/js/55.d9bde558.js"><link rel="prefetch" href="/assets/js/56.8b10a0bb.js"><link rel="prefetch" href="/assets/js/6.53ee40a5.js"><link rel="prefetch" href="/assets/js/7.ebd1c2a4.js"><link rel="prefetch" href="/assets/js/8.00714ceb.js"><link rel="prefetch" href="/assets/js/9.f806a901.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4b6acbbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/cs/" class="sidebar-heading clickable router-link-active open"><span>CS</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/ds-algorithms/" class="sidebar-heading clickable"><span>Ds &amp; Algorithms</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/c++/" class="sidebar-heading clickable"><span>C/C++</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/java/" class="sidebar-heading clickable"><span>Java</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/golang/" class="sidebar-heading clickable router-link-active open"><span>Golang</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/cs/golang/gmp调度模型.html" class="active sidebar-link">GMP调度模型</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cs/golang/gmp调度模型.html#goroutine的优势" class="sidebar-link">goroutine的优势</a></li><li class="sidebar-sub-header"><a href="/cs/golang/gmp调度模型.html#m-n模型" class="sidebar-link">M:N模型</a></li><li class="sidebar-sub-header"><a href="/cs/golang/gmp调度模型.html#概念" class="sidebar-link">概念</a></li></ul></li><li><a href="/cs/golang/tips.html" class="sidebar-link">Tips</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/python/" class="sidebar-heading clickable"><span>Python</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/db/" class="sidebar-heading clickable"><span>DB</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/network/" class="sidebar-heading clickable"><span>Network</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/ops/" class="sidebar-heading clickable"><span>Ops</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/kv/" class="sidebar-heading clickable"><span>KV</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/mq/" class="sidebar-heading clickable"><span>MQ</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/kernel/" class="sidebar-heading clickable"><span>Kernel</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/misc/" class="sidebar-heading clickable"><span>Misc</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/mathematics/" class="sidebar-heading clickable"><span>Mathematics</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/mathematics/mml/" class="sidebar-heading clickable open"><span>MML</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/mathematics/mml/calculus.html" class="sidebar-link">微积分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mathematics/mml/calculus.html#概要" class="sidebar-link">概要</a></li></ul></li><li><a href="/mathematics/mml/linear_algebra.html" class="sidebar-link">线性代数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mathematics/mml/linear_algebra.html#概念" class="sidebar-link">概念</a></li></ul></li><li><a href="/mathematics/mml/probability.html" class="sidebar-link">概率论</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mathematics/mml/probability.html#概要" class="sidebar-link">概要</a></li></ul></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="gmp调度模型"><a href="#gmp调度模型" class="header-anchor">#</a> GMP调度模型</h1> <p></p><div class="table-of-contents"><ul><li><a href="#goroutine的优势">goroutine的优势</a></li><li><a href="#m-n模型">M:N模型</a></li><li><a href="#概念">概念</a><ul><li><a href="#work-stealing">Work-stealing</a></li><li><a href="#syscall">Syscall</a></li><li><a href="#spining-thread">Spining-thread</a></li><li><a href="#sysmon">Sysmon</a></li><li><a href="#network-poller">Network-poller</a></li></ul></li></ul></div><p></p> <h2 id="goroutine的优势"><a href="#goroutine的优势" class="header-anchor">#</a> goroutine的优势</h2> <ul><li>内存占用小，栈默认只有2k，运行过程中如果出现不足会自动扩容，而thread的栈是固定大小的，为了防止溢出会分配比goroutine大得多的栈空间。</li> <li>创建、销毁及调度开销小，thread需要陷入内核态，线程切换开销也大，goroutine则是用户态完成。</li> <li>channel通信更安全，thread主要使用共享内存，需要经常使用锁容易踩坑。</li></ul> <h2 id="m-n模型"><a href="#m-n模型" class="header-anchor">#</a> M:N模型</h2> <p>go运行时会创建M个线程，之后创建的N个goroutine就会趋于均匀地调度到这M个线程中执行，N可以远大于M。当然，任一时刻，一个线程只能跑一个goroutine，当goroutine发生阻塞或主动放弃时间片时该线程就会跑别的goroutine。</p> <h2 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h2> <ul><li>G，就是指goroutine，<code>runtime.g</code>结构表示，包含了当前goroutine的状态、堆栈、上下文。</li> <li>M，就是内核线程，<code>runtime.m</code>结构表示，所有的M是有线程栈的。</li> <li>P，早期的实现是没有P的，后面优化引入了逻辑cpu的概念，代表了M所需的上下文环境，全局G队列还是保留，每个P还有个本地队列（CAS实现LockFree），本地队列的G过多的时候会推到全局队列中，阻塞的系统调用返回时找不到空闲的P也会被推到全局队列中。</li></ul> <h3 id="work-stealing"><a href="#work-stealing" class="header-anchor">#</a> Work-stealing</h3> <h3 id="syscall"><a href="#syscall" class="header-anchor">#</a> Syscall</h3> <p>调用syscall后会解绑P，然后M和G被阻塞，syscall状态的P是不能跟别的M绑定的，如果短时间内M被唤醒，这个M会优先绑定这个P，有利于数据的局部性，如果某个P的G执行syscall的时间超过sysmon-tick，就会被设置为idle状态，此时便可以被其它的M绑定。</p> <p>M视角：</p> <ol><li><p>尝试获取同一个P，恢复执行G</p></li> <li><p>尝试获取并绑定idle list中其它的P，执行其中的G</p></li> <li><p>找不到空闲P，把G放回全局队列，自己回到idle list</p></li></ol> <p><strong>注意：GOMAXPROCS无法限制使用了阻塞的syscall线程的数量，它只能限制P的数量</strong></p> <h3 id="spining-thread"><a href="#spining-thread" class="header-anchor">#</a> Spining-thread</h3> <ul><li>类型1，M不带P的找P挂载（一有P释放就结合）</li> <li>类型2，M带P的找G运行（一有runable的G就执行）</li> <li>当有类型1的自旋M存在时，类型2的就不阻塞，因为阻塞会解绑P，立马会被类型1的M抢走</li></ul> <h3 id="sysmon"><a href="#sysmon" class="header-anchor">#</a> Sysmon</h3> <p>也叫监控线程，无需P也可以运行，作用有如下几点：</p> <ul><li>释放闲置超过5分钟的span物理内存</li> <li>如果超过2分钟没有gc，强制执行</li> <li>将长时间未处理的netpoll添加到全局队列</li> <li>向长时间运行的G任务发出抢占调度</li> <li>收回因syscall长时间阻塞的P</li></ul> <h3 id="network-poller"><a href="#network-poller" class="header-anchor">#</a> Network-poller</h3> <p>G发起网络IO操作不会导致M被阻塞，仅仅G被阻塞，从而不会导致大量的M被创建出来。将异步IO转换为阻塞IO的部分称为netpoller，打开或者接受连接都被设置为非阻塞模式，如果试图对其进行IO操作，并且fd还没准备好，G会进入gopark函数，将当前的G状态保存，然后切换到新的G执行。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cs/java/tips.html" class="prev">
        Tips
      </a></span> <span class="next"><a href="/cs/golang/tips.html">
        Tips
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7fb0f4ce.js" defer></script><script src="/assets/js/2.c7317423.js" defer></script><script src="/assets/js/24.afc783ad.js" defer></script>
  </body>
</html>
