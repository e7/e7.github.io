<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tips | Notes</title>
    <meta name="generator" content="VuePress 1.9.7">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/assets/css/0.styles.4b6acbbd.css" as="style"><link rel="preload" href="/assets/js/app.7fb0f4ce.js" as="script"><link rel="preload" href="/assets/js/2.c7317423.js" as="script"><link rel="preload" href="/assets/js/14.a47039d6.js" as="script"><link rel="prefetch" href="/assets/js/10.df1b1af3.js"><link rel="prefetch" href="/assets/js/11.1279d4dd.js"><link rel="prefetch" href="/assets/js/12.121cf2f1.js"><link rel="prefetch" href="/assets/js/13.79210df7.js"><link rel="prefetch" href="/assets/js/15.d0e05853.js"><link rel="prefetch" href="/assets/js/16.0e89df48.js"><link rel="prefetch" href="/assets/js/17.d6cdd9d3.js"><link rel="prefetch" href="/assets/js/18.a8fed842.js"><link rel="prefetch" href="/assets/js/19.c6052195.js"><link rel="prefetch" href="/assets/js/20.2a584816.js"><link rel="prefetch" href="/assets/js/21.4b9954e1.js"><link rel="prefetch" href="/assets/js/22.e1340920.js"><link rel="prefetch" href="/assets/js/23.a24588c5.js"><link rel="prefetch" href="/assets/js/24.afc783ad.js"><link rel="prefetch" href="/assets/js/25.373526bb.js"><link rel="prefetch" href="/assets/js/26.5c42c25f.js"><link rel="prefetch" href="/assets/js/27.85b64eba.js"><link rel="prefetch" href="/assets/js/28.1a55cf28.js"><link rel="prefetch" href="/assets/js/29.32608d91.js"><link rel="prefetch" href="/assets/js/3.705706f2.js"><link rel="prefetch" href="/assets/js/30.2f08f732.js"><link rel="prefetch" href="/assets/js/31.02da5ad1.js"><link rel="prefetch" href="/assets/js/32.0aa0124a.js"><link rel="prefetch" href="/assets/js/33.8d2474b3.js"><link rel="prefetch" href="/assets/js/34.25937387.js"><link rel="prefetch" href="/assets/js/35.23bdc8d1.js"><link rel="prefetch" href="/assets/js/36.be6dc842.js"><link rel="prefetch" href="/assets/js/37.18dcf644.js"><link rel="prefetch" href="/assets/js/38.bf256366.js"><link rel="prefetch" href="/assets/js/39.8182e3c8.js"><link rel="prefetch" href="/assets/js/4.76ed34bd.js"><link rel="prefetch" href="/assets/js/40.ee89d836.js"><link rel="prefetch" href="/assets/js/41.50f2b168.js"><link rel="prefetch" href="/assets/js/42.d8212083.js"><link rel="prefetch" href="/assets/js/43.41e5910d.js"><link rel="prefetch" href="/assets/js/44.cbdfc0f8.js"><link rel="prefetch" href="/assets/js/45.99296b2b.js"><link rel="prefetch" href="/assets/js/46.ac56bfc7.js"><link rel="prefetch" href="/assets/js/47.0f30f148.js"><link rel="prefetch" href="/assets/js/48.73d76ad6.js"><link rel="prefetch" href="/assets/js/49.a34467b0.js"><link rel="prefetch" href="/assets/js/5.ff1a6210.js"><link rel="prefetch" href="/assets/js/50.1236f0bd.js"><link rel="prefetch" href="/assets/js/51.bb9d3d6e.js"><link rel="prefetch" href="/assets/js/52.fb26b339.js"><link rel="prefetch" href="/assets/js/53.263e7243.js"><link rel="prefetch" href="/assets/js/54.acdf65c5.js"><link rel="prefetch" href="/assets/js/55.d9bde558.js"><link rel="prefetch" href="/assets/js/56.8b10a0bb.js"><link rel="prefetch" href="/assets/js/6.53ee40a5.js"><link rel="prefetch" href="/assets/js/7.ebd1c2a4.js"><link rel="prefetch" href="/assets/js/8.00714ceb.js"><link rel="prefetch" href="/assets/js/9.f806a901.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4b6acbbd.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Notes</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><a href="/cs/" class="sidebar-heading clickable router-link-active open"><span>CS</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/ds-algorithms/" class="sidebar-heading clickable"><span>Ds &amp; Algorithms</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/c++/" class="sidebar-heading clickable router-link-active open"><span>C/C++</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/cs/c++/cmake.html" class="sidebar-link">CMake</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cs/c++/cmake.html#常用变量" class="sidebar-link">常用变量</a></li><li class="sidebar-sub-header"><a href="/cs/c++/cmake.html#vcpkg" class="sidebar-link">Vcpkg</a></li><li class="sidebar-sub-header"><a href="/cs/c++/cmake.html#tips" class="sidebar-link">Tips</a></li></ul></li><li><a href="/cs/c++/windows.html" class="sidebar-link">Windows</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cs/c++/windows.html#tips" class="sidebar-link">Tips</a></li></ul></li><li><a href="/cs/c++/senitizers.html" class="sidebar-link">Senitizers</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cs/c++/senitizers.html#google-sanitizers" class="sidebar-link">google sanitizers</a></li><li class="sidebar-sub-header"><a href="/cs/c++/senitizers.html#asan分析内存问题" class="sidebar-link">ASAN分析内存问题</a></li></ul></li><li><a href="/cs/c++/tips.html" aria-current="page" class="active sidebar-link">Tips</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/cs/c++/tips.html#拾遗" class="sidebar-link">拾遗</a></li><li class="sidebar-sub-header"><a href="/cs/c++/tips.html#异常安全" class="sidebar-link">异常安全</a></li><li class="sidebar-sub-header"><a href="/cs/c++/tips.html#内存模型" class="sidebar-link">内存模型</a></li><li class="sidebar-sub-header"><a href="/cs/c++/tips.html#套路-idiom" class="sidebar-link">套路（Idiom）</a></li><li class="sidebar-sub-header"><a href="/cs/c++/tips.html#stl" class="sidebar-link">STL</a></li><li class="sidebar-sub-header"><a href="/cs/c++/tips.html#常用开源库" class="sidebar-link">常用开源库</a></li><li class="sidebar-sub-header"><a href="/cs/c++/tips.html#代码片段" class="sidebar-link">代码片段</a></li><li class="sidebar-sub-header"><a href="/cs/c++/tips.html#避坑" class="sidebar-link">避坑</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/java/" class="sidebar-heading clickable"><span>Java</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/golang/" class="sidebar-heading clickable"><span>Golang</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/python/" class="sidebar-heading clickable"><span>Python</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/db/" class="sidebar-heading clickable"><span>DB</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/network/" class="sidebar-heading clickable"><span>Network</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/ops/" class="sidebar-heading clickable"><span>Ops</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/kv/" class="sidebar-heading clickable"><span>KV</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/mq/" class="sidebar-heading clickable"><span>MQ</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/kernel/" class="sidebar-heading clickable"><span>Kernel</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/cs/misc/" class="sidebar-heading clickable"><span>Misc</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/mathematics/" class="sidebar-heading clickable"><span>Mathematics</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group is-sub-group depth-1"><a href="/mathematics/mml/" class="sidebar-heading clickable open"><span>MML</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/mathematics/mml/calculus.html" class="sidebar-link">微积分</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mathematics/mml/calculus.html#概要" class="sidebar-link">概要</a></li></ul></li><li><a href="/mathematics/mml/linear_algebra.html" class="sidebar-link">线性代数</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mathematics/mml/linear_algebra.html#概念" class="sidebar-link">概念</a></li></ul></li><li><a href="/mathematics/mml/probability.html" class="sidebar-link">概率论</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/mathematics/mml/probability.html#概要" class="sidebar-link">概要</a></li></ul></li></ul></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tips"><a href="#tips" class="header-anchor">#</a> Tips</h1> <h2 id="拾遗"><a href="#拾遗" class="header-anchor">#</a> 拾遗</h2> <ul><li><p>构造赋值析构（<a href="https://en.cppreference.com/w/cpp/language/rule_of_three" target="_blank" rel="noopener noreferrer">The rule of three/five/zero<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p> <ul><li><p>C++11之后代码中返回局部对象是可能的</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// 编译器会进行2次overload resolution，第一次将返回值作为右值调用移动构造，</span>
<span class="token comment">// 如果不成功进行第二次，用原本的类型（可能左值可能右值）调用复制构造</span>
std<span class="token double-colon punctuation">::</span>string <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    std<span class="token double-colon punctuation">::</span>string <span class="token function">s</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> s<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// c++17之后纯右值的移动会被copy elision掉</span>
std<span class="token double-colon punctuation">::</span>string t <span class="token operator">=</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// No cop or move is made</span>
</code></pre></div></li> <li><p>一个类要么是<code>final</code>，要么拥有<code>virtual</code>析构函数。</p></li> <li><p>最好加上noexcept修饰，移动构造的初始化列表在noexcept之后。</p></li></ul></li> <li><p>重载</p> <ul><li>右值能被const修饰的左值引用匹配，当函数没有右值版本时会被使用</li></ul></li> <li><p>引用</p> <ul><li><p>万能引用和右值引用</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// universal reference</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">Foo</span> <span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">fun</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rvalue reference</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">auto</span><span class="token operator">&amp;&amp;</span> x <span class="token operator">=</span> y<span class="token punctuation">;</span> <span class="token comment">// universal reference</span>

<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">f</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span>vector<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span><span class="token operator">&amp;&amp;</span> x<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// rvalue reference</span>
</code></pre></div></li> <li><p>引用折叠，现代c++中不允许出现引用的引用，如果出现则会触发引用折叠，更具体点就是模板和类型别名的场景</p> <p>规则：</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// &amp; &amp;、&amp; &amp;&amp;、&amp;&amp; &amp; -&gt; &amp;</span>
<span class="token comment">// &amp;&amp; &amp;&amp; -&gt; &amp;&amp;</span>
<span class="token keyword">using</span> lref <span class="token operator">=</span> <span class="token keyword">int</span> <span class="token operator">&amp;</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> rref <span class="token operator">=</span> <span class="token keyword">int</span> <span class="token operator">&amp;&amp;</span><span class="token punctuation">;</span>

<span class="token keyword">int</span> n <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>
lref<span class="token operator">&amp;</span> r1 <span class="token operator">=</span> n<span class="token punctuation">;</span> <span class="token comment">// int&amp;</span>
rref<span class="token operator">&amp;&amp;</span> r2 <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span> <span class="token comment">// int&amp;&amp;</span>
</code></pre></div></li></ul></li> <li><p>类型转换</p> <ul><li><p><code>reinterpret_cast</code> 尽量少用，常见的是子类往父类转换</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// 打印对象内存</span>
<span class="token keyword">template</span><span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">void</span> <span class="token function">printBytes</span><span class="token punctuation">(</span><span class="token keyword">const</span> T <span class="token operator">&amp;</span>input<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">auto</span> <span class="token operator">*</span>bytes <span class="token operator">=</span> <span class="token generic-function"><span class="token function">reinterpret_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">const</span> std<span class="token double-colon punctuation">::</span>byte <span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul></li> <li><p>杂项</p> <ul><li><p>RVO（return value optimization）不总是起作用，<code>std::move</code>用起来。</p></li> <li><p>nodiscard，告诉编译器该函数的返回值不可被丢弃，否则编译器报warning。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">[</span><span class="token punctuation">[</span>nodiscard<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token keyword">int</span> <span class="token function">value</span><span class="token punctuation">(</span>T<span class="token operator">&amp;&amp;</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>vector的emplace_back/push_back的平均时间复杂度。</p> <p>O(1)，因为不扩容的情况下是O(1)，扩容的情况下可以平摊到之前的每次操作即O(2)</p></li> <li><p><code>std::unique_ptr</code>转<code>std::shared_ptr</code>很容易，代价也很低</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>std<span class="token double-colon punctuation">::</span>shared_ptr<span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span> si <span class="token operator">=</span> std<span class="token double-colon punctuation">::</span><span class="token function">move</span><span class="token punctuation">(</span>std<span class="token double-colon punctuation">::</span><span class="token generic-function"><span class="token function">make_unique</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token keyword">int</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li></ul></li> <li><p><a href="https://wizardforcel.gitbooks.io/100-gcc-tips/content/index.html" target="_blank" rel="noopener noreferrer">100个gcc小技巧<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <h2 id="异常安全"><a href="#异常安全" class="header-anchor">#</a> 异常安全</h2> <h4 id="异常安全等级"><a href="#异常安全等级" class="header-anchor">#</a> 异常安全等级</h4> <ul><li><p>no-throw guarantee 不抛出异常，非常安全，加上<code>noexcept</code>的函数编译器还能优化，原则上加了<code>noexcept</code>之后就<strong>不允许去掉</strong>了，影响太大</p> <blockquote><p>从C++17开始，不能再从函数写可能抛出某种异常。只能声明不能抛出某种异常<code>noexcept</code>，如果一个函数声明不会抛异常，结果抛出异常，C++运行时会调用<code>std::terminate</code>来终止应用程序。</p></blockquote></li> <li><p>basic exception safety guarantee 基本异常安全保证，只能保证没有资源泄露，不保证修改数据的原子性</p></li> <li><p>strong exception safety guarantee 强力异常安全，没有资源泄露，数据的变更是原子的（一种实现方式是使用copy-and-swap idiom）</p></li></ul> <h2 id="内存模型"><a href="#内存模型" class="header-anchor">#</a> 内存模型</h2> <h4 id="顺序一致性"><a href="#顺序一致性" class="header-anchor">#</a> 顺序一致性</h4> <ul><li><p>原子类型默认的模式，即编译器保证源码顺序与执行顺序是一致的（happens-before），不进行指令重排，必要时加入内存屏障防止cpu乱序执行</p></li> <li><p>顺序一致性保证安全的代价是有些场景下同步性能比较低，所以编译器都提供了打破这种规则的机制，体现在c++中就是内存顺序</p> <ul><li>memory_order_relaxed 不做任何限制，如脱缰野马</li> <li>memory_order_acquire 本线程中，后续的原子读操作必须在本条原子操作完成后执行</li> <li>memory_order_release 本线程中，所有本条之前的写操作必须完成后才能执行本条操作</li> <li>memory_order_acq_rel 等价于memory_order_acquire &amp; memory_order_release</li> <li>memory_order_consume 本线程中，后续的原子操作必须在本条操作完成之后才能执行</li> <li>memory_order_seq_cst 默认，即顺序一致</li></ul></li></ul> <h2 id="套路-idiom"><a href="#套路-idiom" class="header-anchor">#</a> 套路（Idiom）</h2> <ul><li><p>copy-and-swap</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// 如果类需要支持复制构造应该使用该惯用法，为了遵循The Rule Of Zeor/Three/Five，还是比较常用的。</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">T</span><span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">Array</span> <span class="token punctuation">{</span>
  <span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">void</span> <span class="token function">swap</span><span class="token punctuation">(</span>Array<span class="token operator">&amp;</span> other<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{</span>
        <span class="token keyword">using</span> std<span class="token double-colon punctuation">::</span>swap<span class="token punctuation">;</span>
        <span class="token function">swap</span><span class="token punctuation">(</span>m_size<span class="token punctuation">,</span> other<span class="token punctuation">.</span>m_size<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">swap</span><span class="token punctuation">(</span>m_data<span class="token punctuation">,</span> other<span class="token punctuation">.</span>m_data<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 注意这里传值触发拷贝构造，同时支持拷贝构造（左值）和移动构造（右值）</span>
    Array<span class="token operator">&amp;</span> <span class="token keyword">operator</span><span class="token operator">=</span><span class="token punctuation">(</span>Array other<span class="token punctuation">)</span> <span class="token keyword">noexcept</span> <span class="token punctuation">{</span>
        <span class="token function">swap</span><span class="token punctuation">(</span>other<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>curiously recurring template pattern</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token comment">// 简称CRTP，用于实现编译时多态</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">class</span> <span class="token class-name">Derived</span><span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Base</span> <span class="token punctuation">{</span> <span class="token keyword">void</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>Derived<span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">D1</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span><span class="token operator">&lt;</span><span class="token class-name">D1</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span> <span class="token keyword">void</span> <span class="token function">impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;D1::impl()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">struct</span> <span class="token class-name">D2</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Base</span><span class="token operator">&lt;</span><span class="token class-name">D2</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span> <span class="token keyword">void</span> <span class="token function">impl</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> std<span class="token double-colon punctuation">::</span><span class="token function">puts</span><span class="token punctuation">(</span><span class="token string">&quot;D2::impl()&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
 
<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Base<span class="token operator">&lt;</span>D1<span class="token operator">&gt;</span> b1<span class="token punctuation">;</span> b1<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    Base<span class="token operator">&lt;</span>D2<span class="token operator">&gt;</span> b2<span class="token punctuation">;</span> b2<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    D1 d1<span class="token punctuation">;</span> d1<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    D2 d2<span class="token punctuation">;</span> d2<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>mixin</p> <details class="custom-block details"><summary>示例1</summary> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">struct</span> <span class="token class-name">Number</span><span class="token punctuation">{</span>
  <span class="token keyword">typedef</span> <span class="token keyword">int</span> value_type<span class="token punctuation">;</span>  value_type n<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>value_type v<span class="token punctuation">)</span> <span class="token punctuation">{</span> n <span class="token operator">=</span> v<span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">int</span> <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> n<span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// mixin</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">BASE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">T</span> <span class="token operator">=</span> <span class="token keyword">typename</span> <span class="token class-name">BASE</span><span class="token double-colon punctuation">::</span>value_type<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Undoable</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">BASE</span></span><span class="token punctuation">{</span>
  <span class="token keyword">typedef</span> T value_type<span class="token punctuation">;</span>  T before<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> <span class="token punctuation">{</span> before <span class="token operator">=</span> <span class="token class-name">BASE</span><span class="token double-colon punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token class-name">BASE</span><span class="token double-colon punctuation">::</span><span class="token function">set</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">BASE</span><span class="token double-colon punctuation">::</span><span class="token function">set</span><span class="token punctuation">(</span>before<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">BASE</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">T</span> <span class="token operator">=</span> <span class="token keyword">typename</span> <span class="token class-name">BASE</span><span class="token double-colon punctuation">::</span>value_type<span class="token operator">&gt;</span>
<span class="token keyword">struct</span> <span class="token class-name">Redoable</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">BASE</span></span><span class="token punctuation">{</span>
  <span class="token keyword">typedef</span> T value_type<span class="token punctuation">;</span>  T after<span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token function">set</span><span class="token punctuation">(</span>T v<span class="token punctuation">)</span> <span class="token punctuation">{</span> after <span class="token operator">=</span> v<span class="token punctuation">;</span> <span class="token class-name">BASE</span><span class="token double-colon punctuation">::</span><span class="token function">set</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
  <span class="token keyword">void</span> <span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token class-name">BASE</span><span class="token double-colon punctuation">::</span><span class="token function">set</span><span class="token punctuation">(</span>after<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// 类似装饰模式</span>
<span class="token keyword">typedef</span> Redoable<span class="token operator">&lt;</span> Undoable<span class="token operator">&lt;</span>Number<span class="token operator">&gt;</span> <span class="token operator">&gt;</span> ReUndoableNumber<span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">test</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  ReUndoableNumber mynum<span class="token punctuation">;</span>
  mynum<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">42</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
  mynum<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token number">84</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 84</span>
  mynum<span class="token punctuation">.</span><span class="token function">undo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 42</span>
  mynum<span class="token punctuation">.</span><span class="token function">redo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// back to 84</span>
<span class="token punctuation">}</span>
</code></pre></div></details> <details class="custom-block details"><summary>示例2</summary> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> Mixins<span class="token operator">&gt;</span>
<span class="token keyword">class</span> <span class="token class-name">Point</span> <span class="token operator">:</span> <span class="token base-clause"><span class="token keyword">public</span> <span class="token class-name">Mixins</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span></span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">double</span> x<span class="token punctuation">,</span> y<span class="token punctuation">;</span>
  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Mixins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token function">x</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span><span class="token number">0.0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token function">Point</span><span class="token punctuation">(</span><span class="token keyword">double</span> x<span class="token punctuation">,</span> <span class="token keyword">double</span> y<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">Mixins</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">,</span> <span class="token function">x</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">y</span><span class="token punctuation">(</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Label</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  std<span class="token double-colon punctuation">::</span>string label<span class="token punctuation">;</span>
  <span class="token function">Label</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token function">label</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">Color</span> <span class="token punctuation">{</span>
 <span class="token keyword">public</span><span class="token operator">:</span>
  <span class="token keyword">unsigned</span> <span class="token keyword">char</span> red <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> green <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> blue <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">using</span> MyPoint <span class="token operator">=</span> Point<span class="token operator">&lt;</span>Label<span class="token punctuation">,</span> Color<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div></details></li> <li><p><a href="https://en.wikibooks.org/wiki/More_C%2B%2B_Idioms" target="_blank" rel="noopener noreferrer">更多<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li></ul> <h2 id="stl"><a href="#stl" class="header-anchor">#</a> STL</h2> <ul><li>std::find_if</li> <li>std::any_of, std::all_of, std::none_of</li> <li>std::accumulate</li></ul> <h2 id="常用开源库"><a href="#常用开源库" class="header-anchor">#</a> 常用开源库</h2> <details class="custom-block details"><summary>展开</summary> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 标准库增强</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">www.boost.org</span><span class="token regex-delimiter">/</span></span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>abseil<span class="token operator">/</span>abseil<span class="token operator">-</span>cpp
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>facebook<span class="token operator">/</span>folly

<span class="token comment">// 格式化</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>fmtlib<span class="token operator">/</span>fmt

<span class="token comment">// 网络库</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>pocoproject<span class="token operator">/</span>poco
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>libevent<span class="token operator">/</span>libevent
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>nghttp2<span class="token operator">/</span>nghttp2

<span class="token comment">// web框架</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>drogonframework<span class="token operator">/</span>drogon

<span class="token comment">// ECS</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>skypjack<span class="token operator">/</span>entt

<span class="token comment">// 超快的实时压缩</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>facebook<span class="token operator">/</span>zstd

<span class="token comment">// 带持久化的kv存储</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>facebook<span class="token operator">/</span>rocksdb
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>google<span class="token operator">/</span>leveldb

<span class="token comment">// 日志库</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>gabime<span class="token operator">/</span>spdlog
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>google<span class="token operator">/</span>glog

<span class="token comment">// 测试框架</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>google<span class="token operator">/</span>googletest

<span class="token comment">// 性能分析工具</span>
<span class="token literal-property property">https</span><span class="token operator">:</span><span class="token operator">/</span><span class="token operator">/</span>github<span class="token punctuation">.</span>com<span class="token operator">/</span>gperftools<span class="token operator">/</span>gperftools
</code></pre></div></details> <h2 id="代码片段"><a href="#代码片段" class="header-anchor">#</a> 代码片段</h2> <ul><li><p>计算格式化字符串所需缓冲区大小</p> <details class="custom-block details"><summary>展开</summary> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">int</span> <span class="token function">bufferSize</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> format<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    va_list args<span class="token punctuation">;</span>
    <span class="token function">va_start</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> format<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> result <span class="token operator">=</span> <span class="token function">vsnprintf</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> format<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">va_end</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> result <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// safe byte for \0</span>
<span class="token punctuation">}</span>
</code></pre></div></details></li> <li><p>编译时判断继承关系</p> <details class="custom-block details"><summary>展开</summary> <div class="language-cpp extra-class"><pre class="language-cpp"><code><span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">derived</span><span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">base</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">IsDerived</span> <span class="token punctuation">{</span>
<span class="token keyword">private</span><span class="token operator">:</span>
    <span class="token comment">// 类模板嵌套只能偏特化</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">int</span> n<span class="token punctuation">,</span> <span class="token keyword">typename</span> <span class="token class-name">ign</span><span class="token operator">=</span><span class="token keyword">void</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">CSizeBox</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        CSizeBox<span class="token operator">&lt;</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> ign<span class="token operator">&gt;</span> box1<span class="token punctuation">;</span>
        CSizeBox<span class="token operator">&lt;</span>n<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> ign<span class="token operator">&gt;</span> box2<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">template</span> <span class="token operator">&lt;</span><span class="token keyword">typename</span> <span class="token class-name">ign</span><span class="token operator">&gt;</span> <span class="token keyword">class</span> <span class="token class-name">CSizeBox</span><span class="token operator">&lt;</span><span class="token number">0</span><span class="token punctuation">,</span> ign<span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span><span class="token operator">:</span>
        <span class="token keyword">char</span> c<span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    CSizeBox<span class="token operator">&lt;</span><span class="token number">0</span><span class="token operator">&gt;</span> <span class="token function">Check</span><span class="token punctuation">(</span>base <span class="token keyword">const</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
    CSizeBox<span class="token operator">&lt;</span><span class="token number">1</span><span class="token operator">&gt;</span> <span class="token function">Check</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">const</span><span class="token punctuation">;</span>
 
<span class="token keyword">public</span><span class="token operator">:</span>
    <span class="token keyword">constexpr</span> <span class="token keyword">bool</span> <span class="token keyword">operator</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span>
            <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>base <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">==</span>
            <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token function">Check</span><span class="token punctuation">(</span><span class="token generic-function"><span class="token function">static_cast</span><span class="token generic class-name"><span class="token operator">&lt;</span>derived <span class="token keyword">const</span><span class="token operator">*</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token keyword">nullptr</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">operator</span> <span class="token keyword">bool</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token keyword">const</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></details></li></ul> <h2 id="避坑"><a href="#避坑" class="header-anchor">#</a> 避坑</h2> <ul><li><p>函数返回值都是右值，应小心处理，特别是链式调用。</p> <details class="custom-block details"><summary>展开</summary> <div class="language-cpp extra-class"><pre class="language-cpp"><code>string <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">&quot;hello&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用c_str函数时string对象已经释放</span>
<span class="token comment">// 可以使用一个新的string变量（copy elision）或者使用右值引用延长生命期</span>
cout <span class="token operator">&lt;&lt;</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">c_str</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;&lt;</span> endl<span class="token punctuation">;</span>
</code></pre></div></details></li> <li><p>引用尽量带<code>const</code>，如果没带则需要小心，对其赋值并不会改变其引用的对象，而是修改了已引用的对象。</p></li> <li><p>参考<code>rust</code>借用的思路，是不是传参应该尽量使用<code>std::unique_ptr</code>。</p></li> <li><p>不能对字符串替换顺序作任何假设（c++17之前）。</p> <div class="language-cpp extra-class"><pre class="language-cpp"><code>std<span class="token double-colon punctuation">::</span>string hello <span class="token operator">=</span> <span class="token string">&quot;but I have heard it works even if you don't believe in it.&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// 不能假设哪个replace先执行</span>
hello<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>s<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token string">&quot;even&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">&quot;only&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div></li> <li><p>如果一个类使用<code>std::unique_ptr</code>管理资源，那么这个类不能被拷贝，否则会丢失资源。</p></li> <li><p><code>std::shared_ptr</code>跟线程安全关系不大。</p></li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/cs/c++/senitizers.html" class="prev">
        Senitizers
      </a></span> <span class="next"><a href="/cs/java/tips.html">
        Tips
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.7fb0f4ce.js" defer></script><script src="/assets/js/2.c7317423.js" defer></script><script src="/assets/js/14.a47039d6.js" defer></script>
  </body>
</html>
