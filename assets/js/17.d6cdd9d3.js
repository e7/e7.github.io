(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{453:function(t,a,s){"use strict";s.r(a);var n=s(35),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"mongodb"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#mongodb"}},[t._v("#")]),t._v(" MongoDB")]),t._v(" "),s("PostTags",{attrs:{tags:t.$page.frontmatter.tags}}),t._v(" "),s("p"),s("div",{staticClass:"table-of-contents"},[s("ul",[s("li",[s("a",{attrs:{href:"#索引基础"}},[t._v("索引基础")])]),s("li",[s("a",{attrs:{href:"#重建索引"}},[t._v("重建索引")])]),s("li",[s("a",{attrs:{href:"#查询计划"}},[t._v("查询计划")])]),s("li",[s("a",{attrs:{href:"#使用索引的注意事项"}},[t._v("使用索引的注意事项")])]),s("li",[s("a",{attrs:{href:"#常用命令"}},[t._v("常用命令")])]),s("li",[s("a",{attrs:{href:"#faq"}},[t._v("FAQ")])])])]),s("p"),t._v(" "),s("h2",{attrs:{id:"索引基础"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#索引基础"}},[t._v("#")]),t._v(" 索引基础")]),t._v(" "),s("div",{staticClass:"custom-block warning"},[s("p",{staticClass:"custom-block-title"},[t._v("注意权限")]),t._v(" "),s("p",[t._v("只有属于dbAdmin和dbAdminAnyDatabase角色的用户才能创建或删除索引")])]),t._v(" "),s("ul",[s("li",[s("p",[t._v("可以使用createIndex()函数来为其它（除_id之外）字段创建索引，创建索引时需要指定排序规则（1升序，-1降序）。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COLLECTION_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createIndex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("创建索引的键")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" 排序规则"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("创建索引的参数（可选参数）"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("p",[s("strong",[t._v("索引参数说明")])]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("参数")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("数据类型")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("默认值")]),t._v(" "),s("th",{staticStyle:{"text-align":"center"}},[t._v("功能")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("background")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Boolean")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("false")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("是否后台创建索引（创建索引时不阻塞其它数据库操作）")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("unique")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Boolean")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("false")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("是否创建唯一索引")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("name")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("String")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}}),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("指定索引名称，如未指定，则会自动生成")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("partialFilterExpression")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("document")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}}),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("指定过滤表达式（不为所有记录创建索引，而只为满足条件的记录创建）")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("sparse")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Boolean")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("false")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("稀疏索引，对文档中不存在的字段不启用索引")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("exprireAfterSeconds")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("Integer")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}}),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("指定索引的过期时间")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("storageEngine")]),t._v(" "),s("td",{staticStyle:{"text-align":"center"}}),t._v(" "),s("td",{staticStyle:{"text-align":"center"}}),t._v(" "),s("td",{staticStyle:{"text-align":"center"}},[t._v("针对document类型允许用户配置索引的额外存储引起")])])])])]),t._v(" "),s("li",[s("p",[t._v("可以通过getIndexes()或者getIndexSpecs()函数查看集合中的所有索引信息。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COLLECTION_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getIndexes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[s("strong",[t._v("mongodb不能修改索引，只能先删除再创建")])])]),t._v(" "),s("li",[s("p",[t._v("删除索引")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COLLECTION_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dropIndex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"索引名"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 删除单个索引")]),t._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COLLECTION_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("dropIndexes")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 删除所有索引，_id字段的索引除外")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("索引命中")]),t._v(" "),s("ol",[s("li",[t._v("如果创建的索引只包含1个字段，称为单字段索引。如果多个单字段索引的并集能覆盖查询语句需要的字段，则认为使用了交叉索引。\n"),s("ol",[s("li",[t._v("多key索引，当索引的字段为数组时。")])])]),t._v(" "),s("li",[t._v("如果创建的索引包含多个字段，称为复合索引。如果能命中复合索引，效率是最高的，命中复合索引要求回显的字段包含在复合索引的字段之中，因此这种场景也被称为复合索引覆盖。")])])])]),t._v(" "),s("h2",{attrs:{id:"重建索引"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#重建索引"}},[t._v("#")]),t._v(" 重建索引")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("索引是单独存储的，没有跟文档数据存在一起，在大量数据频繁变化之后会产生索引碎片，所以需要重建索引来整理。")])]),t._v(" "),s("li",[s("p",[t._v("使用reIndex()函数重建索引，可以减少索引存储空间，减少索引碎片，优化查询效率，"),s("strong",[t._v("一般在数据大量变化后")]),t._v("，会使用重建索引来提升性能。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COLLECTION_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("reIndex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])]),t._v(" "),s("h2",{attrs:{id:"查询计划"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#查询计划"}},[t._v("#")]),t._v(" 查询计划")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("查看计划")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token constant"}},[t._v("COLLECTION_NAME")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("explain")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),s("div",{staticClass:"language-json extra-class"},[s("pre",{pre:!0,attrs:{class:"language-json"}},[s("code",[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"queryPlanner"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    ...\n    "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"winninPlan"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token property"}},[t._v('"stage"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"COLLSCAN"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这个字段指示查询性能")]),t._v("\n      ...\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])])]),t._v(" "),s("h2",{attrs:{id:"使用索引的注意事项"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#使用索引的注意事项"}},[t._v("#")]),t._v(" 使用索引的注意事项")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("索引不是越多越好，因为它本身也会消耗存储空间，同时会增加插入、删除和修改操作的开销，另外数据库运行时也要消耗资源维护索引。")])]),t._v(" "),s("li",[s("p",[t._v("当数据量达到万级才需要建索引，否则直接全集合扫描即可。")])]),t._v(" "),s("li",[s("p",[t._v("尽量使用复合索引，而不是交叉索引。")])]),t._v(" "),s("li",[s("p",[t._v("如果复合索引同时包含匹配条件和范围条件，那么匹配条件应放在范围条件之前，换句话说越精确匹配的越靠前。")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 如果查询条件是这样的")]),t._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("find")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("username")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"uuuu"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("age")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("$gt")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 那么应该这样建索引")]),t._v("\ndb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("test"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createIndex")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("username")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token literal-property property"}},[t._v("age")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("查询的时候尽可能只查询索引字段。")])]),t._v(" "),s("li",[s("p",[t._v("对现有数据中的大表建立索引的时候，应采用后台运行的方式。")])]),t._v(" "),s("li",[s("p",[t._v("由于索引是存储在内存中，所以应该确保索引的大小不超过内存限制，否是MongoDB会删除一些索引导致性能下降。")])]),t._v(" "),s("li",[s("p",[t._v("查询限制（有索引但没法用），所以一定要用explain看下。")]),t._v(" "),s("ul",[s("li",[t._v("正则表达式（最左匹配除外）及非操作符，如$nin，$not等")]),t._v(" "),s("li",[t._v("算术运算符，如$mod等")])])]),t._v(" "),s("li",[s("p",[t._v("一个集合中的索引数量不能超过64个，索引名的长度不能超过128个字符，一个复合索引最多有31个字段")])])]),t._v(" "),s("h2",{attrs:{id:"常用命令"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#常用命令"}},[t._v("#")]),t._v(" 常用命令")]),t._v(" "),s("ul",[s("li",[s("p",[t._v("登录")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("auth")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"username"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"password"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])]),t._v(" "),s("li",[s("p",[t._v("切换数据库")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("use dbname\n")])])])]),t._v(" "),s("li",[s("p",[t._v("查看当前集合中哪些字段建了索引")]),t._v(" "),s("div",{staticClass:"language-javascript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-javascript"}},[s("code",[t._v("db"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("collection_name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("getIndexKeys")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])])])]),t._v(" "),s("h2",{attrs:{id:"faq"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#faq"}},[t._v("#")]),t._v(" FAQ")]),t._v(" "),s("ol",[s("li",[s("p",[t._v("即使没有唯一索引，还是会报写入冲突？")]),t._v(" "),s("p",[t._v("原因：大概率是多个事务同时更新同一条记录导致，因为mongodb的事务是乐观锁，事务隔离级别为SI（"),s("a",{attrs:{href:"https://mongoing.com/archives/38461",target:"_blank",rel:"noopener noreferrer"}},[t._v("Snapshot Isolation"),s("OutboundLink")],1),t._v("）。")]),t._v(" "),s("p",[t._v("解决：官方建议在驱动层进行重试，如果没有则需要业务层重试。")])])])],1)}),[],!1,null,null,null);a.default=e.exports}}]);